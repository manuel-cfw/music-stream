version: '3.8'

# ============================================================
# Production Docker Compose for Coolify Deployment
# ============================================================
# This file is optimized for deployment with Coolify.
# All environment variables below should be configured in 
# Coolify's environment settings.
# ============================================================

services:
  mariadb:
    image: mariadb:10.11
    container_name: unified-playlist-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - unified-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: unified-playlist-api
    restart: always
    environment:
      # Application
      NODE_ENV: production
      APP_URL: ${APP_URL}
      API_URL: ${API_URL}
      
      # Database
      DB_HOST: mariadb
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      
      # JWT Authentication
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-15m}
      JWT_REFRESH_EXPIRES_IN: ${JWT_REFRESH_EXPIRES_IN:-7d}
      
      # Encryption
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      
      # Spotify OAuth
      SPOTIFY_CLIENT_ID: ${SPOTIFY_CLIENT_ID}
      SPOTIFY_CLIENT_SECRET: ${SPOTIFY_CLIENT_SECRET}
      SPOTIFY_REDIRECT_URI: ${SPOTIFY_REDIRECT_URI}
      
      # SoundCloud OAuth
      SOUNDCLOUD_CLIENT_ID: ${SOUNDCLOUD_CLIENT_ID}
      SOUNDCLOUD_CLIENT_SECRET: ${SOUNDCLOUD_CLIENT_SECRET}
      SOUNDCLOUD_REDIRECT_URI: ${SOUNDCLOUD_REDIRECT_URI}
      
      # Email (SMTP)
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM}
      
      # Rate Limiting
      RATE_LIMIT_TTL: ${RATE_LIMIT_TTL:-60}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "3000:3000"
    depends_on:
      mariadb:
        condition: service_healthy
    networks:
      - unified-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        VITE_API_URL: ${VITE_API_URL}
        VITE_APP_NAME: ${VITE_APP_NAME:-Unified Playlist Manager}
    container_name: unified-playlist-web
    restart: always
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - unified-network

volumes:
  mariadb_data:
    driver: local

networks:
  unified-network:
    driver: bridge
